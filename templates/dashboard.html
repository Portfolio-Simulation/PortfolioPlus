{% extends "base.html" %}
{% set active_page = 'dashboard' %}

{% block title %}Dashboard | Portfolio+{% endblock %}

{% block extra_head %}
<style>
    .market-movers-list {
        max-height: 200px;
        overflow-y: auto;
    }
    #marketChart {
        height: 380px;
        width: 100%;
    }
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }
    @media (max-width: 992px) {
        .summary-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    @media (max-width: 576px) {
        .summary-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Left Sidebar -->
    <div class="col-lg-3">
        <!-- Welcome Card -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-accent-subtle rounded-circle d-flex align-items-center justify-content-center" style="width: 44px; height: 44px;">
                        <i class="fas fa-user text-accent"></i>
                    </div>
                    <div class="ms-3">
                        <h6 class="mb-0">Welcome back</h6>
                        <span class="text-secondary" style="font-size: 0.85rem;">{{ first_name }}</span>
                    </div>
                </div>
                <div class="stat-label">Available Balance</div>
                <div class="balance-amount" style="font-size: 1.75rem; font-weight: 700; color: var(--accent);">
                    ${{ "{:,.2f}".format(wallet_balance) }}
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-bolt text-accent me-2"></i>Quick Actions
            </div>
            <div class="card-body">
                <a href="/stocks" class="quick-action-btn">
                    <i class="fas fa-magnifying-glass-chart"></i> Browse Stocks
                </a>
                <a href="/portfolio" class="quick-action-btn">
                    <i class="fas fa-briefcase"></i> View Portfolio
                </a>
                <a href="/watchlist" class="quick-action-btn">
                    <i class="fas fa-eye"></i> My Watchlist
                </a>
            </div>
        </div>

        <!-- Market Movers -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-arrow-trend-up text-accent me-2"></i>Market Movers
            </div>
            <div class="card-body">
                <h6 class="text-success mb-2" style="font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">
                    <i class="fas fa-caret-up me-1"></i>Top Gainers
                </h6>
                <div id="topGainers" class="market-movers-list mb-3">
                    <div class="text-center text-secondary py-3">
                        <div class="spinner-accent mx-auto mb-2" style="width: 1.5rem; height: 1.5rem; border-width: 2px;"></div>
                    </div>
                </div>

                <h6 class="text-danger mb-2" style="font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">
                    <i class="fas fa-caret-down me-1"></i>Top Losers
                </h6>
                <div id="topLosers" class="market-movers-list">
                    <div class="text-center text-secondary py-3">
                        <div class="spinner-accent mx-auto mb-2" style="width: 1.5rem; height: 1.5rem; border-width: 2px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-lg-9">
        <!-- Market Chart -->
        <div class="chart-container mb-4">
            <div class="chart-header">
                <h5><i class="fas fa-chart-line text-accent me-2"></i>Market Indices</h5>
                <div class="d-flex gap-1">
                    <button class="time-btn" onclick="updateChart('1M')">1M</button>
                    <button class="time-btn" onclick="updateChart('3M')">3M</button>
                    <button class="time-btn" onclick="updateChart('6M')">6M</button>
                    <button class="time-btn active" onclick="updateChart('1Y')">1Y</button>
                </div>
            </div>
            <div style="padding: 1rem;">
                <div id="marketChart"></div>
            </div>
        </div>

        <!-- Market Summary Cards -->
        <div class="summary-grid">
            {% for index in ['S&P 500', 'Dow Jones', 'NASDAQ', 'Russell 2000', 'FTSE Europe', 'Emerging Markets'] %}
            <div class="stat-card text-center">
                <div class="stat-label">{{ index }}</div>
                <div class="stat-value" id="{{ index.lower().replace(' ', '').replace('&', '') }}Price" style="font-size: 1.4rem;">--</div>
                <div class="mt-1" id="{{ index.lower().replace(' ', '').replace('&', '') }}Change" style="font-size: 0.85rem; font-weight: 500;">--</div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Plotly dark theme layout
    const darkLayout = {
        showlegend: true,
        legend: {
            orientation: 'h',
            y: -0.15,
            x: 0.5,
            xanchor: 'center',
            font: { size: 11, color: '#9CA3AF' }
        },
        xaxis: {
            showgrid: true,
            gridcolor: 'rgba(255,255,255,0.05)',
            gridwidth: 1,
            zeroline: false,
            tickfont: { size: 11, color: '#6B7280' },
            linecolor: 'rgba(255,255,255,0.08)'
        },
        yaxis: {
            showgrid: true,
            gridcolor: 'rgba(255,255,255,0.05)',
            gridwidth: 1,
            zeroline: false,
            tickprefix: '$',
            tickfont: { size: 11, color: '#6B7280' },
            linecolor: 'rgba(255,255,255,0.08)'
        },
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 10, r: 20, b: 50, l: 70 },
        hovermode: 'x unified',
        hoverlabel: {
            bgcolor: '#1F2937',
            bordercolor: 'rgba(255,255,255,0.1)',
            font: { color: '#F9FAFB', size: 12 }
        }
    };

    const plotlyConfig = {
        displayModeBar: true,
        displaylogo: false,
        responsive: true,
        modeBarButtonsToRemove: ['lasso2d', 'select2d']
    };

    function updateMarketData() {
        $.get('/get_market_indices', function(data) {
            if (data.error) {
                console.error('Error fetching market data:', data.error);
                return;
            }
            updateMarketChart(data);
            updateMarketSummary(data);
        });
    }

    function updateMarketChart(data) {
        const traces = Object.keys(data).map(symbol => ({
            name: data[symbol].name,
            x: data[symbol].dates,
            y: data[symbol].prices,
            type: 'scatter',
            mode: 'lines',
            line: {
                color: data[symbol].color,
                width: 2,
                shape: 'spline'
            },
            hovertemplate:
                `<b>${data[symbol].name}</b><br>` +
                'Date: %{x}<br>' +
                'Price: $%{y:.2f}<br>' +
                '<extra></extra>'
        }));

        Plotly.newPlot('marketChart', traces, darkLayout, plotlyConfig);
    }

    function updateChart(timeframe) {
        document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');

        $.get(`/get_market_indices?timeframe=${timeframe}`, function(data) {
            if (data.error) {
                console.error('Error fetching market data:', data.error);
                return;
            }
            updateMarketChart(data);
        });
    }

    function updateMarketSummary(data) {
        const indexMap = {
            'SPY': 'sp500',
            'DIA': 'dowjones',
            'QQQ': 'nasdaq',
            'IWM': 'russell2000',
            'VGK': 'ftseeurope',
            'EEM': 'emergingmarkets'
        };

        Object.entries(data).forEach(([symbol, indexData]) => {
            const elementId = indexMap[symbol];
            if (elementId) {
                document.getElementById(`${elementId}Price`).textContent = '$' + indexData.current_price.toFixed(2);

                const changeEl = document.getElementById(`${elementId}Change`);
                const isPositive = indexData.change >= 0;
                const sign = isPositive ? '+' : '';
                changeEl.textContent = `${sign}$${indexData.change.toFixed(2)} (${sign}${indexData.change_percent.toFixed(2)}%)`;
                changeEl.style.color = isPositive ? 'var(--success)' : 'var(--danger)';
            }
        });
    }

    function updateMarketMovers() {
        fetch('/get_market_movers')
            .then(response => response.json())
            .then(data => {
                const gainersHtml = data.gainers && data.gainers.length ? data.gainers.map(stock => `
                    <div class="mover-item">
                        <div>
                            <div class="mover-symbol">${stock.symbol}</div>
                            <div class="mover-name">${stock.name}</div>
                        </div>
                        <div class="text-end">
                            <div class="mover-price">$${stock.price.toFixed(2)}</div>
                            <div class="mover-change text-success">+${stock.change.toFixed(2)}%</div>
                        </div>
                    </div>
                `).join('') : '<div class="empty-state py-2"><p class="mb-0" style="font-size:0.85rem;">No gainers data</p></div>';

                document.getElementById('topGainers').innerHTML = gainersHtml;

                const losersHtml = data.losers && data.losers.length ? data.losers.map(stock => `
                    <div class="mover-item">
                        <div>
                            <div class="mover-symbol">${stock.symbol}</div>
                            <div class="mover-name">${stock.name}</div>
                        </div>
                        <div class="text-end">
                            <div class="mover-price">$${stock.price.toFixed(2)}</div>
                            <div class="mover-change text-danger">${stock.change.toFixed(2)}%</div>
                        </div>
                    </div>
                `).join('') : '<div class="empty-state py-2"><p class="mb-0" style="font-size:0.85rem;">No losers data</p></div>';

                document.getElementById('topLosers').innerHTML = losersHtml;
            })
            .catch(error => {
                console.error('Error:', error);
                const errorHtml = '<div class="empty-state py-2"><p class="mb-0" style="font-size:0.85rem;">Error loading data</p></div>';
                document.getElementById('topGainers').innerHTML = errorHtml;
                document.getElementById('topLosers').innerHTML = errorHtml;
            });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        updateMarketData();
        updateMarketMovers();
        setInterval(updateMarketData, 300000);
        setInterval(updateMarketMovers, 60000);
    });
</script>
{% endblock %}
