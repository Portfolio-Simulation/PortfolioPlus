{% extends "base.html" %}
{% set active_page = 'stocks' %}

{% block title %}Stocks | Portfolio+{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0" style="font-weight: 700;">
        <i class="fas fa-chart-line text-accent me-2"></i>Stock Market
    </h4>
    <span class="text-secondary" style="font-size: 0.85rem;">
        <i class="fas fa-clock me-1"></i>Real-time prices via Finnhub
    </span>
</div>

<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Company</th>
                        <th>Prev Close</th>
                        <th>Price</th>
                        <th>Change</th>
                        <th>Volume</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if stocks %}
                        {% for stock in stocks %}
                        <tr>
                            <td>
                                <a href="#" class="stock-symbol-link" data-symbol="{{ stock.symbol }}">{{ stock.symbol }}</a>
                            </td>
                            <td style="color: var(--text-secondary);">{{ stock.company_name }}</td>
                            <td>${{ stock.prev_price }}</td>
                            <td style="font-weight: 600;">${{ stock.current_price }}</td>
                            <td>
                                <span class="{% if stock.gain_loss >= 0 %}text-profit{% else %}text-loss{% endif %}" style="font-weight: 500;">
                                    {% if stock.gain_loss >= 0 %}+{% endif %}{{ stock.gain_loss }} ({{ stock.percent_change }}%)
                                </span>
                            </td>
                            <td style="color: var(--text-muted);">{{ '{:,.0f}'.format(stock.volume) }}</td>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn btn-success-dark btn-sm buy-btn" data-symbol="{{ stock.symbol }}">Buy</button>
                                    <button class="btn btn-danger-dark btn-sm sell-btn" data-symbol="{{ stock.symbol }}">Sell</button>
                                    <i class="fas fa-eye watchlist-icon {% if stock.in_watchlist %}active{% else %}inactive{% endif %}"
                                       data-symbol="{{ stock.symbol }}" title="Toggle watchlist"></i>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="7">
                                <div class="empty-state">
                                    <i class="fas fa-chart-bar"></i>
                                    <p>No stocks available at the moment</p>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Stock Details Modal -->
<div class="modal fade" id="stockDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="stockDetailsModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="stockChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Buy/Sell Modal -->
<div class="modal fade" id="buySellModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt text-accent me-2"></i>Trade Stock
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="buySellForm">
                    <div class="mb-3">
                        <label class="form-label">Stock Symbol</label>
                        <input type="text" id="stockSymbol" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Transaction Type</label>
                        <select id="transactionType" class="form-select">
                            <option value="buy">Buy</option>
                            <option value="sell">Sell</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" step="0.01" id="stockQuantity" class="form-control" min="0.01" value="1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount ($)</label>
                        <input type="number" step="0.01" id="totalAmount" class="form-control">
                    </div>
                    <div class="alert alert-danger d-none" id="errorMessage" style="background: var(--danger-bg); border-color: rgba(239,68,68,0.2); color: var(--danger);"></div>
                    <div class="alert alert-success d-none" id="successMessage" style="background: var(--success-bg); border-color: rgba(16,185,129,0.2); color: var(--success);"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-accent" id="confirmTransaction">Confirm Trade</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    $(document).ready(function() {
        const buySellModal = new bootstrap.Modal(document.getElementById('buySellModal'));
        const stockDetailsModal = new bootstrap.Modal(document.getElementById('stockDetailsModal'));

        // Stock detail chart
        $('.stock-symbol-link').click(function(e) {
            e.preventDefault();
            const symbol = $(this).data('symbol');
            const companyName = $(this).text();

            $('#stockDetailsModalLabel').text(`${symbol} - ${companyName}`);
            stockDetailsModal.show();

            $('#stockChart').html(`
                <div class="d-flex justify-content-center align-items-center" style="height: 400px;">
                    <div class="spinner-accent"></div>
                </div>
            `);

            $.ajax({
                url: `/get_stock_history/${symbol}`,
                method: 'GET',
                success: function(data) {
                    if (data.error) {
                        $('#stockChart').html(`
                            <div class="empty-state">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p>${data.error}</p>
                            </div>
                        `);
                    } else {
                        const trace = {
                            x: data.dates,
                            y: data.prices,
                            type: 'scatter',
                            mode: 'lines',
                            line: { color: '#8B5CF6', width: 2 },
                            fill: 'tozeroy',
                            fillcolor: 'rgba(139, 92, 246, 0.08)',
                            name: 'Price'
                        };
                        const layout = {
                            xaxis: {
                                showgrid: true,
                                gridcolor: 'rgba(255,255,255,0.05)',
                                tickfont: { color: '#6B7280', size: 11 },
                                linecolor: 'rgba(255,255,255,0.08)'
                            },
                            yaxis: {
                                showgrid: true,
                                gridcolor: 'rgba(255,255,255,0.05)',
                                tickprefix: '$',
                                tickfont: { color: '#6B7280', size: 11 },
                                linecolor: 'rgba(255,255,255,0.08)'
                            },
                            plot_bgcolor: 'rgba(0,0,0,0)',
                            paper_bgcolor: 'rgba(0,0,0,0)',
                            margin: { t: 20, r: 20, b: 40, l: 60 },
                            hovermode: 'x unified',
                            hoverlabel: {
                                bgcolor: '#1F2937',
                                bordercolor: 'rgba(255,255,255,0.1)',
                                font: { color: '#F9FAFB' }
                            }
                        };
                        Plotly.newPlot('stockChart', [trace], layout, {
                            displayModeBar: false,
                            responsive: true
                        });
                    }
                },
                error: function() {
                    $('#stockChart').html(`
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Error loading chart data</p>
                        </div>
                    `);
                }
            });
        });

        // Buy/Sell
        let currentPrice = 0;

        $('.buy-btn, .sell-btn').click(function() {
            const symbol = $(this).data('symbol');
            currentPrice = parseFloat($(this).closest('tr').find('td:eq(3)').text().replace('$', ''));
            const transactionType = $(this).hasClass('buy-btn') ? 'buy' : 'sell';

            $('#stockSymbol').val(symbol);
            $('#transactionType').val(transactionType);
            $('#stockQuantity').val(1);
            $('#totalAmount').val(currentPrice.toFixed(2));
            $('#errorMessage').addClass('d-none');
            $('#successMessage').addClass('d-none');
            buySellModal.show();
        });

        $('#stockQuantity').on('input', function() {
            const quantity = parseFloat($(this).val());
            if (!isNaN(quantity)) {
                $('#totalAmount').val((quantity * currentPrice).toFixed(2));
            }
        });

        $('#totalAmount').on('input', function() {
            const amount = parseFloat($(this).val());
            if (!isNaN(amount) && currentPrice > 0) {
                $('#stockQuantity').val((amount / currentPrice).toFixed(2));
            }
        });

        $('#confirmTransaction').click(function() {
            const symbol = $('#stockSymbol').val();
            const transactionType = $('#transactionType').val();
            const quantity = parseFloat($('#stockQuantity').val());
            const amount = parseFloat($('#totalAmount').val());

            if (isNaN(quantity) || isNaN(amount) || quantity <= 0 || amount <= 0) {
                $('#errorMessage').text('Invalid quantity or amount.').removeClass('d-none');
                $('#successMessage').addClass('d-none');
                return;
            }

            $.ajax({
                url: '/process_transaction',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ symbol, transaction_type: transactionType, quantity, amount }),
                success: function(response) {
                    if (response.error) {
                        $('#errorMessage').text(response.error).removeClass('d-none');
                        $('#successMessage').addClass('d-none');
                    } else {
                        $('#successMessage').text(transactionType === 'buy' ? 'Buy order confirmed!' : 'Sell order confirmed!').removeClass('d-none');
                        $('#errorMessage').addClass('d-none');
                        setTimeout(() => location.reload(), 1500);
                    }
                },
                error: function() {
                    $('#errorMessage').text('Transaction failed. Please try again.').removeClass('d-none');
                    $('#successMessage').addClass('d-none');
                }
            });
        });

        // Watchlist toggle
        $('.watchlist-icon').click(function() {
            const icon = $(this);
            const symbol = icon.data('symbol');

            $.ajax({
                url: `/toggle_watchlist/${symbol}`,
                method: 'POST',
                success: function(response) {
                    if (response.in_watchlist) {
                        icon.removeClass('inactive').addClass('active');
                    } else {
                        icon.removeClass('active').addClass('inactive');
                    }
                },
                error: function() {
                    console.error('Error updating watchlist');
                }
            });
        });
    });
</script>
{% endblock %}
