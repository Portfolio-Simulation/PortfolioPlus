{% extends "base.html" %}
{% set active_page = 'stocks' %}

{% block title %}Stocks | Portfolio+{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0" style="font-weight: 700;">
        <i class="fas fa-chart-line text-accent me-2"></i>Stock Market
    </h4>
    <span class="text-secondary" style="font-size: 0.85rem;">
        <i class="fas fa-clock me-1"></i>Real-time prices via Finnhub
    </span>
</div>

<!-- Top bar: count, search, filters -->
<div class="card mb-4">
    <div class="card-body py-3">
        <div class="d-flex flex-wrap align-items-center gap-3">
            <span class="text-secondary" style="font-size: 0.85rem;">
                <span id="stockCount">{{ stocks|length if stocks else 0 }}</span> stocks
            </span>
            <input type="text" id="stocksSearch" class="form-control form-control-sm stocks-search-input flex-grow-1" placeholder="Search symbol or company..." style="min-width: 200px; max-width: 420px;">
            <button class="btn btn-sm stocks-filter-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#stocksFiltersOffcanvas" aria-controls="stocksFiltersOffcanvas" title="Filter by sector and market cap">
                <i class="fas fa-sliders-h me-1"></i>
                <span>Filters</span>
                <span id="filterBadge" class="filter-badge d-none">0</span>
            </button>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="stocksTable">
                <thead>
                    <tr>
                        <th class="stocks-sortable" data-sort="symbol">Symbol <i class="fas fa-sort text-muted ms-1" style="font-size: 0.7rem;"></i></th>
                        <th class="stocks-sortable" data-sort="company">Company <i class="fas fa-sort text-muted ms-1" style="font-size: 0.7rem;"></i></th>
                        <th>Prev Close</th>
                        <th class="stocks-sortable" data-sort="price">Price <i class="fas fa-sort text-muted ms-1" style="font-size: 0.7rem;"></i></th>
                        <th class="stocks-sortable" data-sort="change">Change <i class="fas fa-sort text-muted ms-1" style="font-size: 0.7rem;"></i></th>
                        <th class="stocks-sortable" data-sort="sector">Sector <i class="fas fa-sort text-muted ms-1" style="font-size: 0.7rem;"></i></th>
                        <th class="stocks-sortable" data-sort="market-cap">Market cap <i class="fas fa-sort text-muted ms-1" style="font-size: 0.7rem;"></i></th>
                        <th>Held</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="stocksTableBody">
                    {% if stocks %}
                        {% for stock in stocks %}
                        {% set qty = holdings.get(stock.symbol, 0) if holdings is defined else 0 %}
                        <tr class="stock-row" data-symbol="{{ stock.symbol }}" data-company="{{ stock.company_name|lower }}" data-sector="{{ stock.sector or 'N/A' }}" data-market-cap="{{ stock.market_cap or 'N/A' }}" data-price="{{ stock.current_price }}" data-change="{{ stock.percent_change }}">
                            <td>
                                <a href="#" class="stock-symbol-link" data-symbol="{{ stock.symbol }}">{{ stock.symbol }}</a>
                            </td>
                            <td style="color: var(--text-secondary);">{{ stock.company_name }}</td>
                            <td>${{ stock.prev_price }}</td>
                            <td style="font-weight: 600;">${{ stock.current_price }}</td>
                            <td>
                                <span class="{% if stock.gain_loss >= 0 %}text-profit{% else %}text-loss{% endif %}" style="font-weight: 500;">
                                    {% if stock.gain_loss >= 0 %}+{% endif %}{{ stock.gain_loss }} ({{ stock.percent_change }}%)
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-accent-subtle text-accent" style="border: 1px solid rgba(139,92,246,0.2); font-weight: 500; font-size: 0.75rem;">{{ stock.sector or 'N/A' }}</span>
                            </td>
                            <td>
                                <span class="badge bg-accent-subtle text-accent" style="border: 1px solid rgba(139,92,246,0.2); font-weight: 500; font-size: 0.75rem;">{{ stock.market_cap or 'N/A' }}</span>
                            </td>
                            <td>
                                {% if qty and qty > 0 %}
                                <span class="portfolio-holding-badge">{{ qty }} share{{ 's' if qty != 1 else '' }}</span>
                                {% else %}
                                <span class="text-muted" style="font-size: 0.8rem;">â€”</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn btn-success-dark btn-sm buy-btn" data-symbol="{{ stock.symbol }}">Buy</button>
                                    <button class="btn btn-danger-dark btn-sm sell-btn" data-symbol="{{ stock.symbol }}">Sell</button>
                                    <i class="fas fa-eye watchlist-icon {% if stock.in_watchlist %}active{% else %}inactive{% endif %}"
                                       data-symbol="{{ stock.symbol }}" title="Toggle watchlist"></i>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="9">
                                <div class="empty-state">
                                    <i class="fas fa-chart-bar"></i>
                                    <p>No stocks available at the moment</p>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Filters slide-out panel (only visible when opened) -->
<div class="offcanvas offcanvas-end stocks-filters-offcanvas" id="stocksFiltersOffcanvas" tabindex="-1" aria-labelledby="filtersOffcanvasTitle">
    <div class="offcanvas-header border-bottom border-secondary">
        <h5 class="offcanvas-title" id="filtersOffcanvasTitle">
            <i class="fas fa-filter text-accent me-2"></i>Filter stocks
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body p-0">
        <p class="px-3 pt-2 mb-0 text-muted small">Select sectors and market caps, then click Apply. Leave all unchecked to show everything.</p>
        <div class="filter-sections">
            <div class="filter-section">
                <button type="button" class="filter-section-toggle" aria-expanded="false" data-section="marketcap">
                    <i class="fas fa-chevron-down filter-section-chevron"></i>
                    <span>Market cap</span>
                </button>
                <div class="filter-section-body closed">
                    {% for m in unique_market_caps if m %}
                    <label class="filter-option">
                        <input type="checkbox" class="filter-cb filter-cb-marketcap" value="{{ m }}">
                        <span>{{ m }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            <div class="filter-section">
                <button type="button" class="filter-section-toggle" aria-expanded="false" data-section="sector">
                    <i class="fas fa-chevron-down filter-section-chevron"></i>
                    <span>Sector</span>
                </button>
                <div class="filter-section-body closed">
                    {% for s in unique_sectors if s %}
                    <label class="filter-option">
                        <input type="checkbox" class="filter-cb filter-cb-sector" value="{{ s }}">
                        <span>{{ s }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="filter-footer border-top border-secondary">
            <button type="button" class="btn btn-sm btn-accent w-100 mb-2" id="filterApplyBtn">
                <i class="fas fa-check me-1"></i>Apply filters
            </button>
            <button type="button" class="btn btn-sm btn-ghost w-100" id="filterClearBtn">
                <i class="fas fa-times me-1"></i>Clear all filters
            </button>
        </div>
    </div>
</div>

<!-- Stock Details Modal -->
<div class="modal fade" id="stockDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="stockDetailsModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="stockChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Buy/Sell Modal -->
<div class="modal fade" id="buySellModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt text-accent me-2"></i>Trade Stock
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="buySellForm">
                    <div class="mb-3">
                        <label class="form-label">Stock Symbol</label>
                        <input type="text" id="stockSymbol" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Transaction Type</label>
                        <select id="transactionType" class="form-select">
                            <option value="buy">Buy</option>
                            <option value="sell">Sell</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" step="0.01" id="stockQuantity" class="form-control" min="0.01" value="1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount ($)</label>
                        <input type="number" step="0.01" id="totalAmount" class="form-control">
                    </div>
                    <div class="alert alert-danger d-none" id="errorMessage" style="background: var(--danger-bg); border-color: rgba(239,68,68,0.2); color: var(--danger);"></div>
                    <div class="alert alert-success d-none" id="successMessage" style="background: var(--success-bg); border-color: rgba(16,185,129,0.2); color: var(--success);"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-accent" id="confirmTransaction">Confirm Trade</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    $(document).ready(function() {
        const buySellModal = new bootstrap.Modal(document.getElementById('buySellModal'));
        const stockDetailsModal = new bootstrap.Modal(document.getElementById('stockDetailsModal'));

        // Stock detail chart (delegated for dynamically added rows)
        $(document).on('click', '.stock-symbol-link', function(e) {
            e.preventDefault();
            const symbol = $(this).data('symbol');
            const companyName = $(this).text();

            $('#stockDetailsModalLabel').text(`${symbol} - ${companyName}`);
            stockDetailsModal.show();

            $('#stockChart').html(`
                <div class="d-flex justify-content-center align-items-center" style="height: 400px;">
                    <div class="spinner-accent"></div>
                </div>
            `);

            $.ajax({
                url: `/get_stock_history/${symbol}`,
                method: 'GET',
                success: function(data) {
                    if (data.error) {
                        $('#stockChart').html(`
                            <div class="empty-state">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p>${data.error}</p>
                            </div>
                        `);
                    } else {
                        const trace = {
                            x: data.dates,
                            y: data.prices,
                            type: 'scatter',
                            mode: 'lines',
                            line: { color: '#8B5CF6', width: 2 },
                            fill: 'tozeroy',
                            fillcolor: 'rgba(139, 92, 246, 0.08)',
                            name: 'Price'
                        };
                        const layout = {
                            xaxis: {
                                showgrid: true,
                                gridcolor: 'rgba(255,255,255,0.05)',
                                tickfont: { color: '#6B7280', size: 11 },
                                linecolor: 'rgba(255,255,255,0.08)'
                            },
                            yaxis: {
                                showgrid: true,
                                gridcolor: 'rgba(255,255,255,0.05)',
                                tickprefix: '$',
                                tickfont: { color: '#6B7280', size: 11 },
                                linecolor: 'rgba(255,255,255,0.08)'
                            },
                            plot_bgcolor: 'rgba(0,0,0,0)',
                            paper_bgcolor: 'rgba(0,0,0,0)',
                            margin: { t: 20, r: 20, b: 40, l: 60 },
                            hovermode: 'x unified',
                            hoverlabel: {
                                bgcolor: '#1F2937',
                                bordercolor: 'rgba(255,255,255,0.1)',
                                font: { color: '#F9FAFB' }
                            }
                        };
                        Plotly.newPlot('stockChart', [trace], layout, {
                            displayModeBar: false,
                            responsive: true
                        });
                    }
                },
                error: function() {
                    $('#stockChart').html(`
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Error loading chart data</p>
                        </div>
                    `);
                }
            });
        });

        // Buy/Sell (delegated for dynamically added rows)
        let currentPrice = 0;

        $(document).on('click', '.buy-btn, .sell-btn', function() {
            const symbol = $(this).data('symbol');
            currentPrice = parseFloat($(this).closest('tr').find('td:eq(3)').text().replace(/\$/g, '').replace(/,/g, ''));
            const transactionType = $(this).hasClass('buy-btn') ? 'buy' : 'sell';

            $('#stockSymbol').val(symbol);
            $('#transactionType').val(transactionType);
            $('#stockQuantity').val(1);
            $('#totalAmount').val(currentPrice.toFixed(2));
            $('#errorMessage').addClass('d-none');
            $('#successMessage').addClass('d-none');
            buySellModal.show();
        });

        $('#stockQuantity').on('input', function() {
            const quantity = parseFloat($(this).val());
            if (!isNaN(quantity)) {
                $('#totalAmount').val((quantity * currentPrice).toFixed(2));
            }
        });

        $('#totalAmount').on('input', function() {
            const amount = parseFloat($(this).val());
            if (!isNaN(amount) && currentPrice > 0) {
                $('#stockQuantity').val((amount / currentPrice).toFixed(2));
            }
        });

        $('#confirmTransaction').click(function() {
            const symbol = $('#stockSymbol').val();
            const transactionType = $('#transactionType').val();
            const quantity = parseFloat($('#stockQuantity').val());
            const amount = parseFloat($('#totalAmount').val());

            if (isNaN(quantity) || isNaN(amount) || quantity <= 0 || amount <= 0) {
                $('#errorMessage').text('Invalid quantity or amount.').removeClass('d-none');
                $('#successMessage').addClass('d-none');
                return;
            }

            const modalBody = document.querySelector('#buySellModal .modal-body');
            showTxProcessing(modalBody);
            $('#buySellModal .modal-footer').hide();

            $.ajax({
                url: '/process_transaction',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ symbol, transaction_type: transactionType, quantity, amount }),
                success: function(response) {
                    if (response.error) {
                        showTxResult(modalBody, false, response.error);
                        setTimeout(() => { $('#txOverlay').remove(); $('#buySellModal .modal-footer').show(); }, 2000);
                    } else {
                        const msg = transactionType === 'buy' ? 'Buy order confirmed!' : 'Sell order confirmed!';
                        showTxResult(modalBody, true, msg);
                        setTimeout(() => location.reload(), 1800);
                    }
                },
                error: function() {
                    showTxResult(modalBody, false, 'Transaction failed');
                    setTimeout(() => { $('#txOverlay').remove(); $('#buySellModal .modal-footer').show(); }, 2000);
                }
            });
        });

        // Watchlist toggle (delegated for dynamically added rows)
        $(document).on('click', '.watchlist-icon', function() {
            const icon = $(this);
            const symbol = icon.data('symbol');

            $.ajax({
                url: `/toggle_watchlist/${symbol}`,
                method: 'POST',
                success: function(response) {
                    if (response.in_watchlist) {
                        icon.removeClass('inactive').addClass('active');
                    } else {
                        icon.removeClass('active').addClass('inactive');
                    }
                },
                error: function() {
                    console.error('Error updating watchlist');
                }
            });
        });

        // --- Search filter ---
        $('#stocksSearch').on('input', function() {
            var q = $(this).val().toLowerCase().trim();
            applyFilters();
        });

        function getSelectedSectors() {
            var out = [];
            $('.filter-cb-sector:checked').each(function() { out.push($(this).val()); });
            return out;
        }
        function getSelectedMarketCaps() {
            var out = [];
            $('.filter-cb-marketcap:checked').each(function() { out.push($(this).val()); });
            return out;
        }
        function updateFilterBadge() {
            var n = getSelectedSectors().length + getSelectedMarketCaps().length;
            var $badge = $('#filterBadge');
            if (n > 0) {
                $badge.text(n).removeClass('d-none');
            } else {
                $badge.addClass('d-none');
            }
        }

        $('#filterApplyBtn').on('click', function() {
            applyFilters();
            updateFilterBadge();
            var offcanvasEl = document.getElementById('stocksFiltersOffcanvas');
            var offcanvas = bootstrap.Offcanvas.getInstance(offcanvasEl);
            if (offcanvas) offcanvas.hide();
        });

        $('#filterClearBtn').on('click', function() {
            $('.filter-cb').prop('checked', false);
            applyFilters();
            updateFilterBadge();
        });

        $(document).on('click', '.filter-section-toggle', function() {
            var $btn = $(this);
            var $body = $btn.closest('.filter-section').find('.filter-section-body');
            var open = $btn.attr('aria-expanded') === 'true';
            $btn.attr('aria-expanded', !open);
            $body.toggleClass('closed', open);
        });

        function applyFilters() {
            var searchQ = $('#stocksSearch').val().toLowerCase().trim();
            var selectedSectors = getSelectedSectors();
            var selectedMarketCaps = getSelectedMarketCaps();
            var visible = 0;
            $('.stock-row').each(function() {
                var row = $(this);
                var symbol = (row.data('symbol') || '').toLowerCase();
                var company = row.data('company') || '';
                var sector = row.data('sector') || '';
                var marketCap = row.data('market-cap') || '';
                var matchSearch = !searchQ || symbol.indexOf(searchQ) !== -1 || company.indexOf(searchQ) !== -1;
                var matchSector = selectedSectors.length === 0 || selectedSectors.indexOf(sector) !== -1;
                var matchMarketCap = selectedMarketCaps.length === 0 || selectedMarketCaps.indexOf(marketCap) !== -1;
                if (matchSearch && matchSector && matchMarketCap) {
                    row.show();
                    visible++;
                } else {
                    row.hide();
                }
            });
            $('#stockCount').text(visible);
        }

        // --- Sortable columns ---
        var sortCol = null;
        var sortDir = 1;

        $('#stocksTable thead th.stocks-sortable').on('click', function() {
            var col = $(this).data('sort');
            if (sortCol === col) sortDir = -sortDir; else sortDir = 1;
            sortCol = col;

            var rows = $('#stocksTableBody tr.stock-row').get();
            rows.sort(function(a, b) {
                var aVal, bVal;
                var $a = $(a), $b = $(b);
                switch (col) {
                    case 'symbol':
                        aVal = $a.data('symbol');
                        bVal = $b.data('symbol');
                        return sortDir * (aVal < bVal ? -1 : aVal > bVal ? 1 : 0);
                    case 'company':
                        aVal = ($a.data('company') || '').toLowerCase();
                        bVal = ($b.data('company') || '').toLowerCase();
                        return sortDir * (aVal < bVal ? -1 : aVal > bVal ? 1 : 0);
                    case 'price':
                        aVal = parseFloat($a.data('price'));
                        bVal = parseFloat($b.data('price'));
                        return sortDir * (aVal - bVal);
                    case 'change':
                        aVal = parseFloat($a.data('change'));
                        bVal = parseFloat($b.data('change'));
                        return sortDir * (aVal - bVal);
                    case 'sector':
                        aVal = ($a.data('sector') || '').toLowerCase();
                        bVal = ($b.data('sector') || '').toLowerCase();
                        return sortDir * (aVal < bVal ? -1 : aVal > bVal ? 1 : 0);
                    case 'market-cap':
                        aVal = ($a.data('market-cap') || '').toLowerCase();
                        bVal = ($b.data('market-cap') || '').toLowerCase();
                        return sortDir * (aVal < bVal ? -1 : aVal > bVal ? 1 : 0);
                    default:
                        return 0;
                }
            });
            $.each(rows, function(i, row) {
                $('#stocksTableBody').append(row);
            });
        });
    });
</script>
{% endblock %}
